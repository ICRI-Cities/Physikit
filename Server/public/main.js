/**
 * Created by Steven on 12-5-2015.
 */

//Local javascript file

//websocket
var socket;

//login the user with id (id: 1-5 depending on famility/kit; can be changed to more complex
//password and username)
function Login(id){

    //First thing the client does is send credentials to authentication rest call
    $.get("http://localhost:3000/api/" + id, function(secret){

        //data should be a new secret token generated by the server using the id
        //of the client + the secret on the server.

        //Something bad happened, data is http error message we send if id is not
        //recognized
        if(secret =="405 access denied")
        {
            //We can do UI stuff to show bad login
            console.log(secret);
            return;
        }

        //Connect to the socket with out secret
        connect_socket(secret);

        //Set a cookie with our id, NOT the secret
        $.cookie("physikit",id);

        console.log("send id "+ id);

        //Uodate UI
        SwitchLogin(false,id);
    });
}


//Connect the socket with secret
function connect_socket (token) {
    console.log("Log in response:" + token.token);

    //Connect to server with secret
    socket = io.connect('http://localhost:3000', {
        'query': 'token=' + token.token
    });

    //Handles "sck" messages related to smart citizen api
    //updates send by our app over socket.io
    socket.on('sck', function(msg){
        HandleSmartCitizenMessage(msg);
    });

    //Handles "spm" messages related to physikit api
    //updates send by our app over socket.io
    socket.on('spm',function(source,msg){
        HandlePhysikitMessage(source,msg);
    });

    //Handles "rules" messages related to new rules
    //updates send by our app over socket.io
    socket.on('rules',function(rule){
        HandleRuleMessage(rule);
    })

    //Handles "onconnect" socket.io event
    socket.on("connect",function(msg){
        //send an it so server know which kit we need
        socket.emit('id', $.cookie("physikit"));
    });

    //Problem with token
    socket.on("error", function(error) {
        if (error.type == "UnauthorizedError" || error.code == "invalid_token") {
            // redirect user to login page perhaps?
            console.log("Bad token");
        }
    });
}

//Send new message to Physikit node app
//id: 1-5 depending on famility/kit
//sensor: light, fan, buzz or move
//mode: 0-9
//setting: 0-9
//value: 0-9
function Send(id,sensor,mode,setting,value){
    socket.emit('message',id,sensor,mode,setting,value);
};


//Html event handlers for Button
function HandleLogIn(){
    var content = $( "#logIn").val();
    Login(content);
}
function HandleLogOut(){
    $.removeCookie("physikit");
    SwitchLogin(true);
    socket.disconnect();
}

//Update UI
function SwitchLogin(value,username){
    if(value){
        $("#loginForm").show();
        $("#loggedInForm").hide();
    }else{
        $("#loginForm").hide();
        $("#loggedInForm").show();
        $("#username").text("You are logged in as: " + username);
        $("#username").prop('disabled', false);

    }
}

//On document load
$(document).ready(function() {

    //Check for cookie todo auto login
    var cookieValue = $.cookie("physikit");
    if(cookieValue == undefined)
        SwitchLogin(true)
    else
        Login(cookieValue);

    //JQUERY STUFF Initialize accordion
    $("#accordion").accordion({
        header: "h3"
    });

    //JQUERY STUFF  Initialize synchronized checkbox slider
    $("[type='checkbox']").bootstrapSwitch();

    //Initialize slider + switch events
    HandleSwitchEvent("light",true);
    HandleSwitchEvent("fan",true);
});

//Handles Smart Citizen message and updates UI
function HandleSmartCitizenMessage(data){
    $.getJSON("http://api.smartcitizen.me/v0.0.1/a84d28b66e96ebdae9115007d4af2199b226c1fa/2165/posts.json", function (data) {
        console.log(data.device.last_insert_datetime);
        $("#sc").html(
            "You are currently connected to a device named "
            + data.device.title
            + " that is located in "
            + data.device.location
            + ". "
            + "The temperature in <strong><span style='color: #ff0000'>"
            + data.device.location
            + "</span></strong> is currently "
            + data.device.posts[0].temp + " and the co level is "
            + data.device.posts[0].co + ".");
    });
}

//Handles Physikit Messages
function HandlePhysikitMessage(source,data){
    var msg = data.data;
    var mode = msg.substring(0,1);
    var setting = msg.substring(2,3);
    var value = msg.substring(4,msg.toString().length);
    var checkState = (value > 0);

    if(mode == 0){
        if($('#'+source+'Checkbox').get(0).checked != checkState)
        {
            $('#'+source+'Checkbox').bootstrapSwitch("state",checkState,true);
            HandleMainSwitch(source,checkState,false);
        }
        else{
            $('#'+source+'Slider').slider('value', value);
            $('#'+source+'SliderValue').text(value);
        }
    }else if(mode ==1){
        if($('#'+source+'AlertCheckbox').get(0).checked !=  checkState)
        $('#'+source+'AlertCheckbox').bootstrapSwitch("state",checkState,true);
        HandleSecondarySwitch(source,checkState,false);
    }
}

//Handle Rule Messages
function HandleRuleMessage(data){
    var msg = data;
    console.log(msg);
};

//Handle UI switches to control Kit
function HandleMainSwitch(sensor,state,sendmessage){
    //Grab value and toggle state based on switch state (checked == true)
    var value = (state) ? 255:0;
    var on = (value == 255);

    //if state is on:
    // - send the value over socket
    // - adjust the slider and value field
    // - turn off the alert switch if needed
    if(on){
        if(sendmessage)
            Send(1,sensor,0,0,value);
        $('#'+sensor+'Slider').slider('value', value);
        $('#'+sensor+'SliderValue').text(value);
        if($('#'+sensor+'AlertCheckbox').get(0).checked)
            $('#'+sensor+'AlertCheckbox').bootstrapSwitch("state",!value);
    }

    //if state is off:
    // - only send the value over socket if other switch is also off
    // - reset the slider and value field
    if(!on){
        if(!$('#'+sensor+'AlertCheckbox').get(0).checked) {
            if(sendmessage)
                Send(1,sensor,0,0,value);
        }
        $('#'+sensor+'Slider').slider('value', value);
        $('#'+sensor+'SliderValue').text(value);
    }
};

//Handle interval switch for kit
function HandleSecondarySwitch(sensor,state,sendmessage){
    //Grab value and toggle state based on switch state (checked == true)
    var value = (state) ? 255 : 0;
    var on = (value == 255);

    //if state is on:
    // - turn the main checkbox switch off
    // - send the value over socket
    if(on){
        $('#'+sensor+'Checkbox').bootstrapSwitch("state",!on);
        if(sendmessage)
            Send(1,sensor,1,0,value);
    }

    //if state is off:
    // - only send the value over socket if main switch is also off
    if(!on){
        if(!$('#'+sensor+'Checkbox').get(0).checked) {
            if(sendmessage)
                Send(1,sensor,1,0,value);
        }
    }
}

//Handle slides
function HandleSliders(sensor,value,sendmessage){
    //Send the value over socket
    if(sendmessage)
        Send(1,sensor,0,0,value);

    //Calculate toggle state based on slider value
    var state = (value>0) ? true : false;

    //Set the main switch
    $('#'+sensor+'Checkbox').bootstrapSwitch("state",state);
}

//Generic handler that works for every 'sensor' keyword
//and their representations in the UI.
//E.g. 'light'
// -> #lightCheckbox
// -> #lightAlertCheckbox
// -> #lightSlider
// -> #lightSliderValue
function HandleSwitchEvent(sensor,sendmessage){
    //Handle the basic switch event
    $('#'+sensor+'Checkbox').on('switchChange.bootstrapSwitch', function(event, state) {
        HandleMainSwitch(sensor,state,sendmessage);
    });

    //Handle the alert box switch event
    $('#'+sensor+'AlertCheckbox').on('switchChange.bootstrapSwitch', function(event, state) {

        HandleSecondarySwitch(sensor,state,sendmessage);
    });

    //Handles the sliders
    $('#'+sensor+'Slider').slider({
        orientation: "horizontal",
        range: "min",
        min: 0,
        max: 255,
        value: 0,

        //We don't want to send data continuously, so we only
        //send data when the slide adjustment is done
        stop: function (event, ui) {

            HandleSliders(sensor,ui.value,sendmessage);
        },

        //While sliding is going on
        slide: function (event, ui) {

            //Update the value field
            $('#'+sensor+'SliderValue').text(ui.value);
        }
    });
}
